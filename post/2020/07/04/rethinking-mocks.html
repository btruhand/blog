<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Re-thinking Mocks | btruhand - scattering of thoughts</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Re-thinking Mocks" />
<meta name="author" content="btruhand" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Lessons from using mocks in software testing" />
<meta property="og:description" content="Lessons from using mocks in software testing" />
<link rel="canonical" href="https://btruhand.github.io/blog/post/2020/07/04/rethinking-mocks" />
<meta property="og:url" content="https://btruhand.github.io/blog/post/2020/07/04/rethinking-mocks" />
<meta property="og:site_name" content="btruhand - scattering of thoughts" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-04T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://btruhand.github.io/blog/post/2020/07/04/rethinking-mocks","@type":"BlogPosting","headline":"Re-thinking Mocks","dateModified":"2020-07-04T00:00:00-05:00","datePublished":"2020-07-04T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://btruhand.github.io/blog/post/2020/07/04/rethinking-mocks"},"author":{"@type":"Person","name":"btruhand"},"description":"Lessons from using mocks in software testing","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://btruhand.github.io/blog/feed.xml" title="btruhand - scattering of thoughts" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-186226858-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-186226858-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">btruhand - scattering of thoughts</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/recently-i-learned/">RIL</a><a class="page-link" href="/blog/about/">About</a><a class="page-link" href="/blog/oh-interesting/">Oh! Interesting...</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Re-thinking Mocks</h1><p class="page-description">Lessons from using mocks in software testing</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-04T00:00:00-05:00" itemprop="datePublished">
        Jul 4, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#java">java</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#TDD">TDD</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#software">software</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#what-are-mocks">What are mocks</a></li>
<li class="toc-entry toc-h1"><a href="#quick-example">Quick example</a></li>
<li class="toc-entry toc-h1"><a href="#the-positives-of-mocks">The positives of mocks</a></li>
<li class="toc-entry toc-h1"><a href="#the-negatives-of-mocks">The negatives of mocks</a></li>
<li class="toc-entry toc-h1"><a href="#an-alternative-for-mocking">An alternative for mocking</a></li>
</ul><p>These days I have mainly been using Java for my professional career (roughly I have been working with Java for a year). I also mainly have been using the
<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/">Spring framework</a> along with its additional libraries at work. One of the things that
I enjoy with Spring is the dependency injection capability that it provides, primarily through the <code class="language-plaintext highlighter-rouge">@Autowired</code> annotation. This quick and easy way to do dependency
injection is also further compounded in testing benefits as Spring also provides easy and seemless way to obtain these dependencies at test time (<code class="language-plaintext highlighter-rouge">@Import</code> and
<code class="language-plaintext highlighter-rouge">@ContextConfiguration</code> to name a few) makes testing much easier. I also make a good amount of use <a href="https://site.mockito.org/">Mockito</a> which makes my development
life much easier through <code class="language-plaintext highlighter-rouge">mocks</code>, and this post is about <code class="language-plaintext highlighter-rouge">mocks</code> and my experience and thoughts on them.</p>

<h1 id="what-are-mocks">
<a class="anchor" href="#what-are-mocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>What are mocks</h1>

<p>This question has been covered in a variety of other posts out there, one of which I found most useful to be <a href="https://martinfowler.com/articles/mocksArentStubs.html">Martin Fowler’s post</a>. In the words of Martin Fowler himself:</p>

<blockquote>
  <p>Mocks use behavior verification, where we instead check to see if the order made the correct calls on the warehouse. We do this check by telling the mock what to expect during setup and asking the mock to verify itself during verification</p>
</blockquote>

<p>At the heart of mocking is behaviour verification, which is the ability to assert what has <strong>happened</strong> during the execution of a test, and not just what the system
under test has produced. Martin Fowler made a clear distinction and emphasis on this part which you can read up on his post.</p>

<h1 id="quick-example">
<a class="anchor" href="#quick-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick example</h1>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ClassA</span> <span class="o">{</span>
    <span class="nc">ClassB</span> <span class="n">dependency</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">shouldDoFunc</span><span class="o">;</span>

    <span class="nc">ClassA</span><span class="o">(</span><span class="nc">ClassB</span> <span class="n">dependency</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">shouldDoFunc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dependency</span> <span class="o">=</span> <span class="n">dependency</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">shouldDoFunc</span> <span class="o">=</span> <span class="n">shouldDoFunc</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">func</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">shouldDoFunc</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">dependency</span><span class="o">.</span><span class="na">doFunc</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ClassB</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">doFunc</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// do something</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// test code below</span>
<span class="kt">void</span> <span class="nf">test_func_whenShouldNotDoFunc_notCallDoFunc</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassB</span> <span class="n">classB</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">ClassB</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassA</span> <span class="n">classA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassA</span><span class="o">(</span><span class="n">classB</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

    <span class="n">classA</span><span class="o">.</span><span class="na">func</span><span class="o">();</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">classB</span><span class="o">,</span> <span class="n">never</span><span class="o">()).</span><span class="na">doFunc</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The above example is extremely contrived but it just barely shows the use case of mocks. The call to the <code class="language-plaintext highlighter-rouge">verify</code> function says that we are trying to verify
that when <code class="language-plaintext highlighter-rouge">shouldDoFunc = false</code>, we expect that <code class="language-plaintext highlighter-rouge">ClassB.doFunc</code> will not be called.</p>

<p>The alternative to using mocks above would be to supply an actual instance of <code class="language-plaintext highlighter-rouge">ClassB</code> (not mocked) and check against the <em>results</em> after calling <code class="language-plaintext highlighter-rouge">ClassA.func</code>.
Now in the above example no values are being returned from any of the function calls so no returned value can be expected, however often such functions causes
side-effects. Common side-effects include calling some API that causes some change, changing the environment settings, performing DB changes such as updates, changing
the state of <code class="language-plaintext highlighter-rouge">ClassB</code> and many more. Such side-effects are testable and verifiable (if there are no side-effects performed by the function I question why the function
exists).</p>

<h1 id="the-positives-of-mocks">
<a class="anchor" href="#the-positives-of-mocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>The positives of mocks</h1>

<p>From my experience thus far using mocks is that it has been beneficial to create tests. Certain testing may require an expensive setup or verification procedure,
which makes tests run slow but also developed more slowly. An alternative to mocks may include creating fakes or stubs (a separate kind of testing entity), which may
also create additional development effort to make and also may require its own maintenance. Though a great deal of this benefit comes from the fact that many languages
have a well-tested and prevalent mocking library.</p>

<p>Mocks also makes creating truly <code class="language-plaintext highlighter-rouge">unit</code> tests easier, and by unit here I mean tests that only put a single class/object under test. Mocks enable me to put the focus
and attention of tests on the specific unit under test and not have to worry about the other interacting pieces. In the example above, the test is made deliberately
about <code class="language-plaintext highlighter-rouge">ClassA.func</code> behaviour when it is in a certain state. In more complex objects under test, this makes some desired fine-grained testing much more approachable
and manageable.</p>

<h1 id="the-negatives-of-mocks">
<a class="anchor" href="#the-negatives-of-mocks" aria-hidden="true"><span class="octicon octicon-link"></span></a>The negatives of mocks</h1>

<p>The biggest drawback using mocking is it requires whitebox testing, in order to verify using mocks we need to know what functions are being called, which essentially
bears down to knowing some level of detail about the implementation of the unit under test. Nowadays I think of this as <em>reflection for testing</em>. Reflection is the
ability to inspect programming constructs at runtime of some code within the code itself. Often this involves passing in names of functions or fields in the form of
strings to specialized reflection APIs. Since access is made via strings, IDEs won’t help you during refactoring which makes mistakes during changes in the codebase
harder to detect. Thankfully a testing is one of the tools we have to safeguard ourselves against our programming mistakes, until the tests start to fail us.</p>

<p>Using reflection capabilities requires the programmer to have clear knowledge about what is and isn’t present and bake that knowledge statically into the code and
it is the same case when we use mocks. Now libraries like <code class="language-plaintext highlighter-rouge">Mockito</code> does enable the use of refactoring through IDE unlike reflection, but mocking doesn’t easily
allow us to change the tests when the dependency calls in the code under test changes. This creates a mismatch between expectation and reality. For example, if in
<code class="language-plaintext highlighter-rouge">ClassA</code> above we change the call of <code class="language-plaintext highlighter-rouge">doFunc</code> to another function <code class="language-plaintext highlighter-rouge">doFunc2</code>, the test would still pass but for very much the wrong reason! The reality is that
<code class="language-plaintext highlighter-rouge">doFunc</code> is no longer a dependency call being made, but the test still expects it as a call to be made and it just so happens the test was verifying that no calls
were to be made. The following test would fail:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">test_func_whenShouldDoFunc_callDoFunc</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassB</span> <span class="n">classB</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">ClassB</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassA</span> <span class="n">classA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassA</span><span class="o">(</span><span class="n">classB</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

    <span class="n">classA</span><span class="o">.</span><span class="na">func</span><span class="o">();</span>
    <span class="n">verify</span><span class="o">(</span><span class="n">classB</span><span class="o">,</span> <span class="n">once</span><span class="o">()).</span><span class="na">doFunc</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>but now the test fails for the wrong reason! The test will fail because the test is expecting the wrong thing, not because the unit under test is behaving
incorrectly. This is test maintenance drag. Martin Fowler calls this the coupling of implementation and testing.</p>

<h1 id="an-alternative-for-mocking">
<a class="anchor" href="#an-alternative-for-mocking" aria-hidden="true"><span class="octicon octicon-link"></span></a>An alternative for mocking</h1>

<p>One of the compelling alternatives to mocking is by supplying functions as parameters to the unit under test instead of whole object dependencies. The ability to pass
functions as parameters is called <a href="https://en.wikipedia.org/wiki/First-class_function">First-class function</a>. Consider this example in pseudo-Javascript</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">funcToTest</span><span class="p">(</span><span class="nx">dependentFunction</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">some</span> <span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dependentFunction</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">test_funcToTest_whenConditionNotMet_doNotCallDependentFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// do something to cause condition to not be met</span>
    <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">funcToTest</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TestFailed</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The passed in <code class="language-plaintext highlighter-rouge">dependentFunction</code> is simply a function passed as a parameter that is called when some condition is met inside <code class="language-plaintext highlighter-rouge">funcToTest</code>. Notice how in the test we
are also verifying the behaviour of <code class="language-plaintext highlighter-rouge">funcToTest</code> under some condition, similar to the example with <code class="language-plaintext highlighter-rouge">ClassA</code>. In both the test using mocks and first-class function we
see that behaviour is being verified, and this should come as no surprise. We can think of objects as instances of namespaces/groupings for functions (with the ability
to maintain and collect some form of internal state) and so when we pass an object as a dependency it can be seen as passing in a collection of functions. The
difference is that when we use mocks we have to explicitly mention the dependent function we are interested in, while with first-class functions the dependent function
is stipulated in formal syntax (scratching off the fact that it’s possible to call functions without their parameters in Javascript). With mocks tests can fail/pass
for reasons of a mismatch between expectation and reality, with first-class functions that possibility is greatly diminished and if it happens is likely the
programmer’s mistake.</p>

<p>However in reality I have not used first-class functions as an alternative to mocks at all. Much the reason is because it is much easier to work with objects and
mocks in Java. Though Java does have lambda functions and the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/FunctionalInterface.html">@FunctionalInterface</a>
it is not that fluid to create classes and methods that take in first-class functions all the time. But this is surely a technique that I would explore and be more
conscious of in the future.</p>

  </div><a class="u-url" href="/blog/post/2020/07/04/rethinking-mocks" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">btruhand</li>
          <li><a class="u-email" href="mailto:btruhand@gmail.com">btruhand@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Btruhand&#39;s blogging outlet, ranging from technical writeups to social opions</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/btruhand" title="btruhand"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/btara-truhandarien" title="btara-truhandarien"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
